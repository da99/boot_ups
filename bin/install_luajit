#!/usr/bin/env bash
# -*- bash -*-
#
this_dir="$(pwd)"
cd ..
boot="$(pwd)"
cd $this_dir

lsrc=luajit-2.0_src
lua_path="$boot/luajit"
set -u -e -o pipefail


sudo apt-get install libc6-dev rlwrap
# rlwrap is needed to wrap readline support with the luajit repl

cd $boot
if [[ -d $lsrc  ]]
then
  cd $lsrc
  git pull
else
  git clone http://luajit.org/git/luajit-2.0.git $lsrc
  cd $lsrc
fi

old="export PREFIX= /usr/local"
new="export PREFIX= $lua_path"
sed -i  "s|$old|$new|" Makefile
make PREFIX="$lua_path"
make install PREFIX="$lua_path"
git checkout Makefile

if [[ "$(command -v luajit)" != "$lua_path/bin/luajit" ]]
then
  echo ""
  echo ""
  echo "======================="
  echo "Put this in your path: "
  echo "export PATH=\"$lua_path/bin:\$PATH\""
  echo "======================="
  echo ""
fi

lua_exec="$lua_path/bin/lua"
if [[ ! -f $lua_exec ]]
then
  cp "$boot/boot_ups/bin/lua" $lua_exec
  chmod +x $lua_exec
fi
